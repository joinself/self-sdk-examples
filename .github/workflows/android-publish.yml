name: _android-publish

on:
  workflow_call:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Setup job
        uses: joinself/github-actions-public/setup-job@main
      - name: Publish
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GHA_TOKEN }}
        run: |
          . ${GITHUB_WORKSPACE}/.ci/env

          workflow="self-sdk-examples:android-publish"
          id=$(date | md5sum | head -c 8)
          gh workflow run ${workflow} -R joinself/github-workflows-dispatch -r main -f id=${id} -f run-id=${CI_RUN_ID}

          echo "CI_RUN_ID: ${CI_RUN_ID}"

          echo "Calling remote workflow: ${workflow} (${id})"
          for ((i = 0; i < 30; i++)); do
            echo "Waiting for workflow to complete..."
            conclusion=$(gh run list -R joinself/github-workflows-dispatch --json name,conclusion --jq ".[] | select(.name==\"${workflow} - ${id}\") | .conclusion")
            [[ "${conclusion}" == "success" ]] && echo "Workflow complete" && exit 0
            [[ "${conclusion}" == "failure" ]] && echo "Workflow failed" && exit 1
            [[ "${i}" == "29" ]] && echo "Workflow timeout" && exit 1
            sleep 10
          done
